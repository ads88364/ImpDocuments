<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>ChipID é‡è¤‡æª¢æŸ¥ (è½‰æ›txté–‹å•Ÿ)</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f9f9f9;
      padding: 30px;
      color: #333;
    }

    h2 {
      margin-bottom: 10px;
    }

    input[type="file"] {
      margin-bottom: 1em;
    }

    #result {
      padding: 1em;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }

    .ok {
      color: green;
      font-weight: bold;
    }

    .ng {
      color: red;
      font-weight: bold;
    }

    table {
      border-collapse: collapse;
      margin-top: 20px;
      width: 100%;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #f0f0f0;
    }

    #tableContainer {
      margin-top: 20px;
    }

    .warning {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>

<body>

  <h2>ğŸ“„ ChipID é‡è¤‡æª¢æŸ¥</h2>
  <input type="file" id="csvFile" accept=".csv,.txt" />
  <div id="warning" class="warning"></div>
  <div id="result"></div>
  <div id="tableContainer"></div>

  <script>
    // æ¸…ç©ºé¸å–ï¼Œç¢ºä¿é¸åŒä¸€æª”æ¡ˆä¹Ÿèƒ½è§¸ç™¼
    document.getElementById("csvFile").addEventListener("click", function () {
      this.value = ""; 
    });

    // ç•¶æª”æ¡ˆé¸æ“‡è®Šæ›´æ™‚è§¸ç™¼
    document.getElementById("csvFile").addEventListener("change", function () {
      const file = this.files[0];
      const warningDiv = document.getElementById("warning");
      const resultDiv = document.getElementById("result");
      const tableContainer = document.getElementById("tableContainer");

      // æ¸…ç©ºç•«é¢å…§å®¹
      warningDiv.innerHTML = "";
      resultDiv.innerHTML = "";
      tableContainer.innerHTML = "";

      if (!file) return;

      const warnings = [];

      // 1.æª¢æŸ¥æª”æ¡ˆåç¨±æ˜¯å¦åŒ…å« 'lotFile'
      if (!file.name.toLowerCase().includes("lotfile")) {
        warnings.push("âŒ éŒ¯èª¤ï¼šæª”åå¿…é ˆåŒ…å« 'lotFile'");
      }

      const reader = new FileReader();

      // 2. ç•¶è®€å–å®Œæˆæ™‚åŸ·è¡Œä»¥ä¸‹é‚è¼¯
      reader.onload = function (e) {
        const lines = e.target.result.split(/\r?\n/).filter(line => line.trim() !== "");

        // 3. å˜—è©¦å¾ç¬¬ 0 æˆ–ç¬¬ 1 è¡Œæ‰¾æ¬„ä½æ¨™é¡Œ
        let headerLineIndex = 0;
        let header = lines[headerLineIndex].split(",");
        if (!header.includes("ChipID") && lines.length > 1) {
          headerLineIndex = 1;
          header = lines[1].split(",");
        }

        // 4. æª¢æŸ¥æ˜¯å¦åŒ…å« ChipID æ¬„ä½
        const chipIdIndex = header.indexOf("ChipID");
        if (chipIdIndex === -1) {
          warnings.push("âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° 'ChipID' æ¬„ä½");
        }

        // 5. æª¢æŸ¥æ˜¯å¦æœ‰ '0.00E+00' ç§‘å­¸è¨˜è™Ÿæ ¼å¼
        const badScientific = lines.some(line => /0\.00E\+00/i.test(line));
        if (badScientific) {
          warnings.push("âš ï¸ åµæ¸¬åˆ°åŒ…å« '0.00E+00'ï¼Œè«‹ç¢ºèªæ˜¯å¦ç‚ºèª¤å­˜æ ¼å¼");
        }

        // 6. é¡¯ç¤ºæ‰€æœ‰è­¦å‘Šè¨Šæ¯
        if (warnings.length > 0) {
          warningDiv.innerHTML = warnings.map(w => `<p class="ng">${w}</p>`).join("");
          if (chipIdIndex === -1) return; // è‹¥æ‰¾ä¸åˆ° ChipID å°±ä¸è™•ç†
        }

        const chipIdMap = {};
        const totalDataRows = lines.length - (headerLineIndex + 1); // âœ… è¨ˆç®—ç¸½è³‡æ–™ç­†æ•¸ï¼ˆä¸å«æ¨™é¡Œï¼‰

        // 7. å°‡æ¯ç­† ChipID è¨˜éŒ„ä¸‹ä¾†å°æ‡‰è¡Œæ•¸
        for (let i = headerLineIndex + 1; i < lines.length; i++) {
          const cols = lines[i].split(",");
          const chipId = cols[chipIdIndex]?.replace(/"/g, "").trim();
          if (!chipId) continue;

          if (!chipIdMap[chipId]) {
            chipIdMap[chipId] = [];
          }
          chipIdMap[chipId].push(i + 1); // è¡Œè™Ÿï¼ˆ1-basedï¼‰
        }

        // 8. æ‰¾å‡ºé‡è¤‡å‡ºç¾çš„ ChipID
        const duplicates = Object.entries(chipIdMap).filter(([id, rows]) => rows.length > 1);
        const totalDuplicateCount = duplicates.reduce((sum, [, rows]) => sum + rows.length, 0);

        // 9. é¡¯ç¤ºçµæœï¼šOK æˆ– NGï¼Œé™„åŠ çµ±è¨ˆ
        if (duplicates.length === 0) {
          resultDiv.innerHTML = `<p class="ok">âœ… çµæœï¼šOKï¼Œæ²’æœ‰é‡è¤‡çš„ ChipIDï¼Œç¸½ç­†æ•¸ç‚º ${totalDataRows} ç­†</p>`;
          return;
        }

        resultDiv.innerHTML = `
          <p class="ng">âŒ çµæœï¼šNGï¼Œå…±ç™¼ç¾ ${duplicates.length} çµ„é‡è¤‡çš„ ChipID</p>
          <p>ğŸ“Œ ç¸½ç­†æ•¸ï¼š${totalDataRows} ç­†</p>
          <p>ğŸ” é‡è¤‡ç¸½ç­†æ•¸ï¼š${totalDuplicateCount} ç­†</p>
        `;

        // 10. å»ºç«‹è¡¨æ ¼é¡¯ç¤ºæ¯ä¸€çµ„é‡è¤‡çš„ ChipID
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const tbody = document.createElement("tbody");

        const headerRow = document.createElement("tr");
        ["ç·¨è™Ÿ", "é‡è¤‡çš„ ChipID", "å‡ºç¾è¡Œæ•¸"].forEach(text => {
          const th = document.createElement("th");
          th.textContent = text;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // 11. å¡«å…¥æ¯ä¸€çµ„é‡è¤‡çš„è³‡æ–™åˆ—
        duplicates.forEach(([chipId, rows], idx) => {
          const tr = document.createElement("tr");

          const tdIndex = document.createElement("td");
          tdIndex.textContent = idx + 1;
          tr.appendChild(tdIndex);

          const tdId = document.createElement("td");
          tdId.textContent = chipId;
          tr.appendChild(tdId);

          const tdRows = document.createElement("td");
          tdRows.textContent = rows.join(", ");
          tr.appendChild(tdRows);

          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        tableContainer.appendChild(table);
      };

      // ä½¿ç”¨ç´”æ–‡å­—æ–¹å¼è®€å– CSV æˆ– TXT æª”
      reader.readAsText(file);
    });
  </script>

</body>

</html>