<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ChipID é‡è¤‡æª¢æŸ¥ ï¼ˆTXT é–‹å•Ÿç‰ˆæœ¬ demo_5ï¼‰</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f9f9f9;
      padding: 30px;
      color: #333;
    }

    h2 {
      margin-bottom: 10px;
    }

    input[type="file"] {
      margin-bottom: 1em;
    }

    #result {
      padding: 1em;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }

    .ok {
      color: green;
      font-weight: bold;
    }

    .ng {
      color: red;
      font-weight: bold;
    }

    table {
      border-collapse: collapse;
      margin-top: 20px;
      width: 100%;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #f0f0f0;
    }

    #tableContainer {
      margin-top: 20px;
    }

    .warning {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h2>ğŸ“„ ChipID é‡è¤‡æª¢æŸ¥ï¼ˆTXT é–‹å•Ÿç‰ˆæœ¬ï¼‰</h2>
  <input type="file" id="csvFile" accept=".csv,.txt" />
  <div id="warning" class="warning"></div>
  <div id="result"></div>
  <div id="tableContainer"></div>

  <script>
    document.getElementById("csvFile").addEventListener("change", function () {
      const file = this.files[0];
      const warningDiv = document.getElementById("warning");
      const resultDiv = document.getElementById("result");
      const tableContainer = document.getElementById("tableContainer");

      warningDiv.innerHTML = "";
      resultDiv.innerHTML = "";
      tableContainer.innerHTML = "";

      if (!file) return;

      const warnings = [];

      // æª¢æŸ¥æª”æ¡ˆåç¨±æ˜¯å¦åŒ…å« lotFile
      if (!file.name.toLowerCase().includes("lotfile")) {
        warnings.push("âŒ éŒ¯èª¤ï¼šæª”åå¿…é ˆåŒ…å« 'lotFile'");
      }

      const reader = new FileReader();

      reader.onload = function (e) {
        const lines = e.target.result.split(/\r?\n/).filter(line => line.trim() !== "");

        // å°‹æ‰¾æ¬„ä½æ¨™é¡Œä½ç½®ï¼ˆå¯èƒ½åœ¨ç¬¬ 0 æˆ–ç¬¬ 1 è¡Œï¼‰
        let headerLineIndex = 0;
        let header = lines[headerLineIndex].split(",");
        if (!header.includes("ChipID") && lines.length > 1) {
          headerLineIndex = 1;
          header = lines[1].split(",");
        }

        // æª¢æŸ¥æ˜¯å¦å­˜åœ¨ ChipID æ¬„ä½
        const chipIdIndex = header.indexOf("ChipID");
        if (chipIdIndex === -1) {
          warnings.push("âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° 'ChipID' æ¬„ä½");
        }

        // æª¢æŸ¥æ˜¯å¦å«æœ‰ 0.00E+00 å½¢å¼
        const badScientific = lines.some(line => /0\.00E\+00/i.test(line));
        if (badScientific) {
          warnings.push("âš ï¸ åµæ¸¬åˆ°åŒ…å« '0.00E+00'ï¼Œè«‹ç¢ºèªæ˜¯å¦ç‚ºèª¤å­˜æ ¼å¼");
        }

        // é¡¯ç¤ºæ‰€æœ‰è­¦å‘Šè¨Šæ¯
        if (warnings.length > 0) {
          warningDiv.innerHTML = warnings.map(w => `<p class="ng">${w}</p>`).join("");
          if (chipIdIndex === -1) return; // æ‰¾ä¸åˆ°æ¬„ä½å°±ä¸ç¹¼çºŒè™•ç†
        }

        // åˆ†æè³‡æ–™åˆ—ï¼ˆå¾ header ä¹‹å¾Œé–‹å§‹ï¼‰
        const chipIdMap = {};
        for (let i = headerLineIndex + 1; i < lines.length; i++) {
          const cols = lines[i].split(",");
          const chipId = cols[chipIdIndex]?.replace(/"/g, "").trim();

          if (!chipId) continue;

          if (!chipIdMap[chipId]) {
            chipIdMap[chipId] = [];
          }
          chipIdMap[chipId].push(i + 1); // è¡Œè™Ÿç”¨ 1-based é¡¯ç¤º
        }

        // æ‰¾å‡ºé‡è¤‡çš„ ChipID
        const duplicates = Object.entries(chipIdMap).filter(([id, rows]) => rows.length > 1);

        if (duplicates.length === 0) {
          resultDiv.innerHTML = `<p class="ok">âœ… çµæœï¼šOKï¼Œæ²’æœ‰é‡è¤‡çš„ ChipID</p>`;
          return;
        }

        resultDiv.innerHTML = `<p class="ng">âŒ çµæœï¼šNGï¼Œå…±ç™¼ç¾ ${duplicates.length} çµ„é‡è¤‡çš„ ChipID</p>`;

        // å»ºç«‹è¡¨æ ¼é¡¯ç¤ºé‡è¤‡çµæœ
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const tbody = document.createElement("tbody");

        const headerRow = document.createElement("tr");
        ["index", "é‡è¤‡çš„ ChipID", "å‡ºç¾è¡Œæ•¸"].forEach(text => {
          const th = document.createElement("th");
          th.textContent = text;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        duplicates.forEach(([chipId, rows], idx) => {
          const tr = document.createElement("tr");

          const tdIndex = document.createElement("td");
          tdIndex.textContent = idx + 1;
          tr.appendChild(tdIndex);

          const tdId = document.createElement("td");
          tdId.textContent = chipId;
          tr.appendChild(tdId);

          const tdRows = document.createElement("td");
          tdRows.textContent = rows.join(", ");
          tr.appendChild(tdRows);

          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        tableContainer.appendChild(table);
      };

      // ä½¿ç”¨ FileReader ä»¥ç´”æ–‡å­—æ–¹å¼é–‹å•Ÿ .csv æˆ– .txt æª”æ¡ˆ
      reader.readAsText(file);
    });
  </script>
</body>
</html>
